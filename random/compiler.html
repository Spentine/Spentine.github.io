<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width">

<title>compilr</title>

<link href="style.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="style.css">

<script>

function copyoutput() {
	str = document.getElementById('output')
	window.getSelection().selectAllChildren(str)
	document.execCommand('Copy')
}
function stageone(text) {
	
	split = text.split('\n')
	split = split.filter(n => n)
	imported = []
	
	for (i=0; i<split.length; i++){
		j = split[i].split(' ')
		k = j.shift()
		if (k == 'import') {
			imported.push(j[0])
			split.splice(i, 1)
			i--
		}
	}
	if (imported.length > 0) {
		split.splice(0, 0, 'jumpflag main')
		split.splice(1, 0, "flag goback","set $temp1 8","add $goback $temp1","jump $goback")
		if (imported.includes('str')) {
			split.splice(1, 0, "flag str.len","set $temp1 0","set $temp2 1","flag $str.len@1","add $temp1 $temp2","set $temp3","join $temp3 $r","letterof $temp3 $temp1","ascii $temp3","jumpflagcond $temp3 $str.len@2 $str.len@1","flag $str.len@2","set $r","set $temp2 -1","add $temp1 $temp2","join $r $temp1","jumpflag goback")
		}
		if (imported.includes('math')) {
			split.splice(1, 0, "flag math.subtract","jumpflagcond $r2 $math.subtract@2 $math.subtract@1","flag $math.subtract@1","set $temp1 -","join $temp1 $r2","jumpflag $math.subtract@3","flag $math.subtract@2","set $temp1 1","set $temp2","set $temp3 1","flag $math.subtract@4","add $temp1 $temp3","set $temp4","join $temp4 $r2","letterof $temp4 $temp1","set $temp5","join $temp5 $temp4","ascii $temp5","jumpflagcond $temp5 $math.subtract@6 $math.subtract@5","flag $math.subtract@5","join $temp2 $temp4","jumpflag $math.subtract@4","flag $math.subtract@6","set $temp1","join $temp1 $temp2","flag $math.subtract@3","add $r1 $temp1","set $r","join $r $r1","jumpflag goback")
		}
	}
	text = []
	for (i=0; i<split.length;i++){
		j = split[i].split(' ')
		k = j.shift()
		if (['str.len'].includes(k)) {
			x = j[0]
			text.push('set $r')
			text.push('join $r ' + x)
			text.push('index $goback')
			text.push('jumpflag ' + k)
			text.push('set ' + x)
			text.push('join ' + x + ' $r')
		} else if (['math.subtract'].includes(k)) {
			x = j[0]
			y = j[1]
			text.push('set $r1')
			text.push('join $r1 ' + x)
			text.push('set $r2')
			text.push('join $r2 ' + y)
			text.push('index $goback')
			text.push('jumpflag math.subtract')
			text.push('set x')
			text.push('join x $r')
		} else {
			text.push(split[i])
		}
	}
	
	text = text.join('\n')
	return text
}

function stagetwo(text) {
	split = text.split('\n')
	text = []
	vars = ['$jump', '$cond', '$add']
	
	for (i=0; i < split.length; i++) {
		j = split[i].split(' ')
		k = j.shift()
		if (k == 'jumpflagcond') {
			split.splice(i, 1)
			split.splice(i, 0, 'jumpflag ' + j[2])
			split.splice(i, 0, 'jumpflag ' + j[1])
			split.splice(i, 0, 'jump $cond ' + j[0])
			split.splice(i, 0, 'add $cond $add')
			split.splice(i, 0, 'index $cond')
			split.splice(i, 0, 'set $add 14')
		}	
	}
	
	for (i=0; i < split.length; i++) {
		j = split[i].split(' ')
		k = j.shift()
		if (k == 'set') {
			if (!(vars.includes(j[0]))) {
				vars.push(j[0])
			}
		} else if (!(['flag', 'jumpflag', '#', '//'].includes(k))) {
			for (k=0; k < j.length; k++) {
				if (!(vars.includes(j[k]))) {
					vars.push(j[k])
				}
			}
		}
	}
	
	for (i=0; i < split.length; i++) {
		j = split[i].split(' ')
		k = j.shift()
		if (!((k == '#') || (k == '//'))) {
			text.push(k)
		}
		if (k == 'set') {
			text.push(vars.indexOf(j.shift()) + 1)
			j = j.join(' ')
			if (j == '') {
				text.push('')
			} else {
				text.push(j)
			}
		} else if (k == 'jumpflag') {
			text.push(j)
			for (l=0; l<4; l++) {
				text.push('reserved for jumping')
			}
		} else if (k == 'flag') {
			text.push(j)
		} else if (k == 'jump') {
			if (j.length == 1) {
				text.push(vars.indexOf(j[0]) + 1)
				text.push(vars.indexOf(j[0]) + 1)
			} else {
				for (k=0; k < j.length; k++) {
					text.push(vars.indexOf(j[k]) + 1)
				}
			}
		} else if (!((k == '#') || (k == '//'))) {
			for (k=0; k < j.length; k++) {
				text.push(vars.indexOf(j[k]) + 1)
			}
		}
	}
	
	flags = {}
	
	for (i=0; i < text.length; i++) {
		if (text[i] == 'flag') {
			flags[text[i+1]] = i+1
			text.splice(i, 2)
			i--
		}
	}
	
	for (i=0; i < text.length; i++) {
		if (text[i] == 'jumpflag') {
			text[i] = 'set'
			text[i+2] = flags[text[i+1]]
			text[i+1] = '1'
			text[i+3] = 'jump'
			text[i+4] = '1'
			text[i+5] = '1'
		}
	}
	
	text = text.join('\n')
	return text
}
function compile() {
	text = document.getElementById('textinput').value
	text = stagetwo(stageone(text))
	document.getElementById('output').innerHTML = text
}
</script>

</head>
<body>
<h1> compiler </h1>
<textarea type="text" id="textinput" rows="12" cols="50" value="" size=50 oninput="compile();"></textarea>
<br><button onclick="copyoutput();"> copy code </button>
<p class="code" id="output" style="font-size:20px">output goes here
</p>
</body>
</html>