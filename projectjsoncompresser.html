<!DOCTYPE html>
<head>
	
	<title> Scratch Compresser </title>
	
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Gantari&display=swap');
		
		body {
			background-color: #112233;
			color: #FFFFFF;
			font-size: 50px;
			font-family: Gantari;
		}
		
		input, select {
			color: inherit;
			font-size: inherit;
			font-family: inherit;
		}
		
		select {
			background-color: #223344;
		}
		
	</style>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
	<script>
		
		// ------------------------------------------ START OF JS SCRIPT ------------------------------------------
		
		/*
		version:
		mode 0: production (final version)
		mode 1: reduction (simply reducing file size but don't make changes)
		
		safe:
		mode 0: unsafe (costume issues)
		mode 1: safe (no issues but higher file size)
		
		hide:
		mode 0: hidden
		mode 1: shown
		*/
		
		mode = {
			'version': 0,
			'safe': 0,
			'hide': 0,
		}
		
		// this is like actually the shittiest script ever like ever
		
		// javascript is a garbage programming language
		const reassignproperties = ['next', 'parent']
		
		const extraInputs = ['CONDITION', 'SUBSTACK', 'SUBSTACK2', 'custom_block', "OPERAND", "OPERAND1", "OPERAND2", "SOUND_MENU", "KEY_OPTION", "TOUCHINGOBJECTMENU", "COSTUME", "CLONE_OPTION", "TO", "TOWARDS", "DRUM", "NOTE", "INSTRUMENT", "ATTRIBUTE", "SUBJECT", "VIDEO_STATE", "MOTOR_ID", "MOTOR_DIRECTION", "OP", "BTN", "DIRECTION", "PIN", "TILT_DIRECTION", "TILT_DIRECTION_ANY", "PORT", "GESTURE", "PUSH_PULL", "TILT", "MOTOR_REPORTER_ID", "VOICE", "LANGUAGE", "COLOR", "KEY", "SEQUENCE", "MATRIX", "POWER", "BACKDROP", "COLOR_PARAM", "DISTANCETOMENU", "OBJECT"]
		
		const hatBlocks = ['event_whenflagclicked', 'event_whenkeypressed', 'event_whenthisspriteclicked', 'event_whenbackdropswitchesto', 'event_whengreaterthan','event_whenbroadcastreceived', 'control_start_as_clone', 'procedures_definition', 'gdxfor_whenForcePushedOrPulled', 'gdxfor_whenTilted', 'videoSensing_whenMotionGreaterThan', 'makeymakey_whenMakeyKeyPressed', 'makeymakey_whenCodePressed', 'microbit_whenButtonPressed', 'microbit_whenGesture', 'microbit_whenTilted', 'microbit_whenPinConnected', 'ev3_whenButtonPressed', 'ev3_whenDistanceLessThan', 'ev3_whenBrightnessLessThan', 'boost_whenColor', 'boost_whenTilted', 'wedo2_whenDistance', 'wedo2_whenTilted', 'gdxfor_whenGesture']
		
		function convertShort(num) {
			chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!#%()*+,-./:;=?[]^`'
			// chars = '0123456789'
			base = chars.length
			result = ''
			while (num > 0) {
				remainder = num % base
				result += chars[remainder]
				num -= remainder
				num /= base
			}
			return result
		}
		
		function numcompiler(num) { 
			/*
			if (num == "NaN") {
				return NaN // bruh i had to comment this out bc the stupid scratch vm no play well with it :(
			}
			*/
			if (num == '') {
				return ''
			}
			/*
			if (num == 'true') {
				return true // also same for these the scra	tch vm sux
			}
			if (num == 'false') {
				return false
			}
			*/
			n = num
			num = Number(n)
			if (isNaN(num)) {
				return n
			}
			if (num == Infinity) {
				return "Infinity"
			}
			if (num.toString() != n) {
				return n
			}
			return num
		}
		
		function compressSB3() {
			
			// Get the selected file
			const fileInput = document.querySelector('input[type="file"]');
			const file = fileInput.files[0];
			
			// TODO: Use JSZip to compress the file
			console.log('Selected file:', file);

			// Create a new JSZip instance
			const zip = new JSZip();
			
			// Load the file data into JSZip
			zip.loadAsync(file)
				.then((zipContents) => {
					project = null
					output = new JSZip();
					zipContents.forEach((relativePath, file) => {
						if ((relativePath == 'compile/project.json') || (relativePath == 'project.json')) {
							project = file
						} else {
							contents = file.async('uint8array');
							output.file(relativePath, contents, { createFolders: true });
						}
					});
					if (project == null) {
						console.log('dumbass programmer imagine hehehe')
						return -1 // fuck u
					}
					// project = zipContents.file('project.json')
					console.log(project)
					project.async('string').then(function (data) {
						// finally u stupid dumbass
						compressedjson = compressString(data)
						output.file("project.json", compressedjson);
						console.log(output)
						console.log('creating zip')
						if (true) { // make it true for download
							output.generateAsync({type:"base64"}).then(function (base64) { // i dont know what the fuck i did but it works so yeah
								console.log('downloading')
								var link = document.createElement('a');
								link.href = 'data:application/sb3;base64,' + base64;
								link.download = 'output.sb3'; // specify the file name here
								link.click();
							});
						}
						return 0
						// return compressString(data)
					})
				})
				.catch((error) => {
					console.error('Error decompressing file:', error);
				});
		}
		
		window.addEventListener('DOMContentLoaded', () => {
			// Attach a change event listener to the file input element
			const fileInput = document.querySelector('input[type="file"]');
			fileInput.addEventListener('change', () => {
				mode = {
					'version': Number(document.getElementById('ver-select').value == 'edit'),
					'safe': Number(document.getElementById('safe-select').value == 'safe'),
					'hide': Number(document.getElementById('hide-select').value == 'show'),
				}
				console.log(mode)
				compressSB3()
			});
		});
		
		/*
		function deleteBlock(project, i, j) { // bruh it should work why isn't it working
			deleteBlocks.push(j)
			bloc = project['targets'][i]['blocks'][j]
			console.log(j)
			console.log(project['targets'][i]['blocks'])
			
			try {
				for (let k in bloc['inputs']) {
					inp = bloc['inputs'][k]
					if (((inp.length >= 3) || ([1, 2, 3].includes(inp[1][0]))) && !([12, 13].includes(inp[1][0]))) {
						deleteBlock(project, i, inp[1][1])
					}
				}
			} catch (e) {
				console.log('dumbass coder')
				console.log(e)
			}
			try {
				if (!(bloc['next'] == null)) {
					deleteBlock(project, i, bloc['next'])
				}
			} catch (e) {
				console.log('bruh no next??')
				console.log(e)
			}
		}
		*/
		
		function compressString(str) {
			console.log('original string length: ' + str.length)
			project = JSON.parse(str)
			
			console.log(project)
			
			replacebroadcastname = true
			
			for (let i in project['targets']) {
				for (let j in project['targets'][i]['blocks']) {
					if ((project['targets'][i]['blocks'][j]['opcode'] == 'event_broadcast') && (project['targets'][i]['blocks'][j]['inputs']['BROADCAST_INPUT'].length == 3)) {
						replacebroadcastname = false
					}
				}
			}
			
			console.log('replacebroadcastname: ' + replacebroadcastname)
			
			broadcastreassignment = {}
			index = 0
			replacebroadcasts = {}
			for (let i in project['targets'][0]['broadcasts']) {
				index += 1
				broadcast = project['targets'][0]['broadcasts']
				if (replacebroadcastname) {
					n = convertShort(index)
				} else {
					n = broadcast[i]
				}
				broadcastreassignment[i] = {'id': convertShort(index), 'name': /*broadcast[i]*/ n}
				replacebroadcasts[broadcastreassignment[i]['id']] = broadcastreassignment[i]['name']
			}
			afterbroadcast = index
			project['targets'][0]['broadcasts'] = replacebroadcasts
			
			for (let i in project['targets']) { // remove unused blocks just floating around
			
				deleteBlocks = []
				
				processes = []
				proccodes = []
				for (let j in project['targets'][i]['blocks']) { // gather all functions and function calls
					bloc = project['targets'][i]['blocks'][j]
					if (bloc['opcode'] == 'procedures_prototype') {
						processes.push(bloc['mutation']['proccode'])
					} else if ((bloc['opcode'] == 'procedures_call') && !(proccodes.includes(bloc['mutation']['proccode']))) {
						proccodes.push(bloc['mutation']['proccode'])
					}
				}
				
				unusedprocesses = []
				for (let j in processes) {
					if (!(proccodes.includes(processes[j]))) {
						unusedprocesses.push(processes[j])
					}
				}
				
				for (let j in project['targets'][i]['blocks']) {
					bloc = project['targets'][i]['blocks'][j]
					if (bloc['opcode'] == 'procedures_definition') {
						if (unusedprocesses.includes(project['targets'][i]['blocks'][bloc['inputs']['custom_block'][1]]['mutation']['proccode'])) {
							deleteBlocks.push(j)
						}
					} else if (bloc['opcode'] == 'event_whenbroadcastreceived') { // replace broadcasts
						x = broadcastreassignment[bloc['fields']['BROADCAST_OPTION'][1]]
						project['targets'][i]['blocks'][j]['fields']['BROADCAST_OPTION'] = [x['name'], x['id']]
					} else if (bloc['opcode'] == 'event_broadcast') { // also replace broadcasts
						if (bloc['inputs']['BROADCAST_INPUT'].length == 2) {
							x = broadcastreassignment[bloc['inputs']['BROADCAST_INPUT'][1][2]]
							project['targets'][i]['blocks'][j]['inputs']['BROADCAST_INPUT'] = [1, [11, x['name'], x['id']]]
						}
					}
				}
				
				for (let j in project['targets'][i]['blocks']) {
					if ((project['targets'][i]['blocks'][j]['topLevel'] == true) && !(hatBlocks.includes(project['targets'][i]['blocks'][j]['opcode']))) { // if it's a stray block just lying around
						// console.log(deleteBlock(project, i, j)) // this should work but javascript is stupidly asynchronous
						deleteBlocks.push(j)
					}
				}

				for (j=0; j<deleteBlocks.length; j++) {
					try {
						for (let k in project['targets'][i]['blocks'][deleteBlocks[j]]['inputs']) { // i aint explaining how this shit works fuck u
							inp = project['targets'][i]['blocks'][deleteBlocks[j]]['inputs'][k]
							if (typeof inp[1] == "string") {
								deleteBlocks.push(inp[1])
							}
						}
					} catch (e) {
						console.log('dumbass coder')
						console.log(e)
					}
					next = project['targets'][i]['blocks'][deleteBlocks[j]]['next']
					if (!(next == null)) {
						deleteBlocks.push(next)
					}
				}
				
				for (j=0; j<deleteBlocks.length; j++) {
					delete project['targets'][i]['blocks'][deleteBlocks[j]] // delete the actual useless blocks
				}
			}
			
			varreassignment = {}
			index = afterbroadcast
			for (let i in project['targets']) { // make vars good
				newlist = {}
				for (let j in project['targets'][i]['lists']) {
					index += 1
					varreassignment[j] = {'id': convertShort(index), 'name': project['targets'][i]['lists'][j][0], 'type': 13}
					newlist[convertShort(index)] = [varreassignment[j]['name'], project['targets'][i]['lists'][j][1]]
				}
				project['targets'][i]['lists'] = newlist
				newvar = {}
				for (let j in project['targets'][i]['variables']) {
					index += 1
					varreassignment[j] = {'id': convertShort(index), 'name': project['targets'][i]['variables'][j][0], 'type': 12}
					newvar[convertShort(index)] = [varreassignment[j]['name'], project['targets'][i]['variables'][j][1]]
				}
				project['targets'][i]['variables'] = newvar
			}
			
			for (let key in project['targets']) {
				
				x = project['targets'][key]['blocks'] // make blockid good hehehehehe
				idreassignment = {}
				index = 0
				for (let i in x) { // assign each one a value
					index += 1	
					idreassignment[i] = convertShort(index)
				}
				reassigned = {}
				for (let i in x) {
					reassigned[idreassignment[i]] = x[i]
				}
				x = reassigned
				for (let i in x) {
					for (j=0;j<2;j++) {
						if (!(x[i][reassignproperties[j]] == null)) {
							x[i][reassignproperties[j]] = idreassignment[x[i][reassignproperties[j]]]
						}
					}
					for (let j in x[i]['inputs']) {
						if (((x[i]['inputs'][j].length >= 3) || ([1, 2, 3].includes(x[i]['inputs'][j][0]))) || (x[i]['opcode'] == 'procedures_prototype')) {
							y = x[i]['inputs'][j][1]
							try {
								if (!([12, 13].includes(y[0]))) {
									x[i]['inputs'][j][1] = idreassignment[y]
									if (x[i]['inputs'][j][1] == undefined) {
										x[i]['inputs'][j][1] = y
									}
								}
							} catch (e) {
								/* ok so 100% of the time this is because one of the values in the operators is null
								console.log('omg your code sux')
								console.log('y: ' + y)
								console.log('i: ' + i)
								console.log('j: ' + j)
								*/ 
							}
						}
						
						if (x[i]['inputs'][j].length >= 3) {
							y = x[i]['inputs'][j][1]
							try {
								if (!([12, 13].includes(y[0]))) {
									x[i]['inputs'][j][1] = [varreassignment[y[2]]['type'], varreassignment[y[2]]['name'], varreassignment[y[2]]['id']]
									if (varreassignment[y] == undefined) {
										x[i]['inputs'][j][1] = y
									}
								}
							} catch (e) {
								x[i]['inputs'][j][1] = y
							}
						}
					}
					for (let j in x[i]['fields']) {
						if (j == 'VARIABLE') {
							re = varreassignment[x[i]['fields']['VARIABLE'][1]]
							x[i]['fields']['VARIABLE'] = [re['name'], re['id']]
						} else if (j == 'LIST') {
							re = varreassignment[x[i]['fields']['LIST'][1]]
							x[i]['fields']['LIST'] = [re['name'], re['id']]
						}
					}
				}
				project['targets'][key]['blocks'] = x // done making blockid good
				
				if (mode['safe'] == 0) { // unsafe
					x = project['targets'][key]["lists"]
					for (let i in x) {
						j = project['targets'][key]['lists'][i][1]
						for (k=0;k<j.length;k++) { // make a variable small
							j[k] = numcompiler(j[k])
						}
						project['targets'][key]['lists'][i][1] = j
					}
				}
				
				if (mode['version'] == 0) { // production
					project['targets'][key]['comments'] = {} // remove comments
					x = project['targets'][key]['blocks']
					for (let i in x) {
						if (x[i]['opcode'] != 'event_broadcast') {
							j = x[i]['inputs']
							for (let k in j) {
								if (j[k].length == 3) {
									j[k][2] = [7, 0]
								} else {
									if (mode['safe'] == 0) { // unsafe
										try {
											j[k][1][1] = numcompiler(j[k][1][1])
										} catch (e) {}
									}
								}
							}
							x[i]['inputs'] = j
						}
						
						if (x[i]["topLevel"]) {
							x[i]['x'] = 0
							x[i]['y'] = 0
						} else {
							if (mode['hide'] == 0) { // hidden
								x[i]['shadow'] = true
							}
						}
						
					}
					project['targets'][key]['blocks'] = x
				}
			}
			
			for (let i in project['monitors']) {
				try {
					id = project['monitors'][i]['id']
					project['monitors'][i]['id'] = varreassignment[id]['id']
					if (varreassignment[id]['type'] == 12) {
						type = 'VARIABLE'
					} else { type = 'LIST' }
					project['monitors'][i]['params'][type] = varreassignment[id]['name']
				} catch (e) {}
			}
			
			console.log(project)
			project = JSON.stringify(project, null, 0)
			console.log('new string length: ' + project.length)
			console.log('saved: ' + (100 - (100 * project.length / str.length)) + '%')
			return project
			
		}
		
		// ------------------------------------------ END OF JS SCRIPT ------------------------------------------
		
	</script>

</head>
<body>

	<input type="file" accept=".sb3" />
	
	<br>
	
	<select id='safe-select'>
		<option value="unsafe">unsafe</option>
		<option value="safe">safe</option>
	</select>
	
	<select id='ver-select'>
		<option value="prod">production</option>
		<option value="edit">editable</option>
	</select>

	<select id='hide-select'>
		<option value="hide">hidden</option>
		<option value="show">shown</option>
	</select>

</body>